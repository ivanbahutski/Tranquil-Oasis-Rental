{% extends 'menu/base.html' %}
{% load i18n static %}

{% block extrastyle %}
<!-- Swiper -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<!-- Lightbox -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css" />
<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<!-- AOS (анимации при прокрутке) -->
<link rel="stylesheet" href="https://unpkg.com/aos@2.3.4/dist/aos.css" />
{% endblock %}

{% block content %}
<div class="container my-5" data-aos="fade-up">

  <!-- Слайдер изображений -->
  <div class="swiper mb-5" data-aos="zoom-in">
    <div class="swiper-wrapper">
      {% for image in property.images.all %}
      <div class="swiper-slide">
        <a href="{{ image.image.url }}" data-lightbox="villa-gallery">
          <img src="{{ image.image.url }}" alt="{{ property.title }}" class="img-fluid rounded shadow-sm"
               style="object-fit: cover; width: 100%; height: 400px;">
        </a>
      </div>
      {% endfor %}
    </div>
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-pagination"></div>
  </div>

  <!-- Информация о вилле -->
  <div class="card shadow-sm p-4 mb-5" data-aos="fade-up">
    <h1>{{ property.title }}</h1>
    <h5 class="text-muted">{{ property.location }}</h5>
    <p class="mt-3">{{ property.description|linebreaks }}</p>
    <h4 class="mt-3 text-success">{{ property.price_per_night }} € / {% trans "night" %}</h4>
  </div>

  <!-- Форма бронирования -->
  <div class="card shadow-sm p-4" data-aos="fade-up">
    <h3>{% trans "Book your stay" %}</h3>
    <form method="post" id="booking-form">
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-md-6">
          <label for="first_name" class="form-label">{% trans "First Name" %}</label>
          <input type="text" id="first_name" name="first_name" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label for="last_name" class="form-label">{% trans "Last Name" %}</label>
          <input type="text" id="last_name" name="last_name" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label for="email" class="form-label">Email</label>
          <input type="email" id="email" name="email" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label for="phone" class="form-label">{% trans "Phone" %}</label>
          <input type="tel" id="phone" name="phone" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label for="guests" class="form-label">{% trans "Number of Guests" %}</label>
          <input type="number" id="guests" name="guests" class="form-control" min="1" max="20" required>
        </div>
        <div class="col-md-6">
          <label for="date_range" class="form-label">{% trans "Select Dates" %}</label>
          <input type="text" id="date_range" name="date_range" class="form-control" required>
        </div>
        <div class="col-md-12">
          <label for="message" class="form-label">{% trans "Special Requests" %}</label>
          <textarea id="message" name="message" class="form-control" rows="3"></textarea>
        </div>
      </div>

      <div class="mt-3 text-muted" id="nights-info"></div>
      <div class="mt-2 text-success fw-bold" id="total-price"></div>

      <div class="mt-4 d-grid">
        <button type="submit" class="btn btn-warning btn-lg">{% trans "Reserve Now" %}</button>
      </div>
    </form>
  </div>

</div>
{% endblock %}

{% block extrascripts %}
<!-- Swiper -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<!-- Lightbox -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>
<!-- Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- AOS -->
<script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>

<script>
// Инициализация Swiper
const swiper = new Swiper('.swiper', {
  loop: true,
  autoplay: {
    delay: 3000,
  },
  pagination: {
    el: '.swiper-pagination',
    clickable: true,
  },
  navigation: {
    nextEl: '.swiper-button-next',
    prevEl: '.swiper-button-prev',
  },
});

// Инициализация AOS
AOS.init({
  duration: 1000,
  once: true
});

// Инициализация Flatpickr
flatpickr("#date_range", {
  mode: "range",
  minDate: "today",
  disable: [
    {% for date in booked_dates %}
      "{{ date }}",
    {% endfor %}
  ],
  onChange: function(selectedDates) {
    const nightsInfo = document.getElementById('nights-info');
    const totalPrice = document.getElementById('total-price');
    if (selectedDates.length === 2) {
      const nights = Math.round((selectedDates[1] - selectedDates[0]) / (1000 * 60 * 60 * 24));
      nightsInfo.textContent = nights + " {% trans 'nights' %}";
      const price = nights * {{ property.price_per_night }};
      totalPrice.textContent = price.toFixed(2) + " €";
    } else {
      nightsInfo.textContent = '';
      totalPrice.textContent = '';
    }
  }
});

// Всплывающее окно после бронирования
{% if booking_success %}
Swal.fire({
  icon: 'success',
  title: 'Reservation Confirmed!',
  text: 'We have sent a confirmation email to you.',
  confirmButtonColor: '#f59e0b'
});
{% endif %}
</script>
{% endblock %}